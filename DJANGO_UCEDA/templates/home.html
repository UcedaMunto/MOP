{% extends 'base.html' %}

{% block title %}Home - MOP Eventos de Tráfico{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-center mb-4">
            <i class="bi bi-house-door text-primary"></i>
            Sistema de Gestión de Eventos de Tráfico
        </h1>
        <p class="text-center text-muted mb-5">Selecciona una tabla para gestionar los datos</p>
    </div>
</div>

<div class="row g-4">
    <!-- Tipos de Evento -->
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm hover-card" data-table="tipos-evento">
            <div class="card-body text-center">
                <i class="bi bi-tags-fill text-warning mb-3" style="font-size: 3rem;"></i>
                <h5 class="card-title">Tipos de Evento</h5>
                <p class="card-text text-muted">Gestionar categorías de eventos</p>
                <button class="btn btn-primary btn-sm" onclick="showOptions('tipos-evento', 'Tipos de Evento')">
                    Gestionar
                </button>
            </div>
        </div>
    </div>

    <!-- Niveles de Gravedad -->
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm hover-card" data-table="niveles-gravedad">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle-fill text-danger mb-3" style="font-size: 3rem;"></i>
                <h5 class="card-title">Niveles de Gravedad</h5>
                <p class="card-text text-muted">Gestionar niveles de importancia</p>
                <button class="btn btn-primary btn-sm" onclick="showOptions('niveles-gravedad', 'Niveles de Gravedad')">
                    Gestionar
                </button>
            </div>
        </div>
    </div>

    <!-- Estados de Evento -->
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm hover-card" data-table="estados-evento">
            <div class="card-body text-center">
                <i class="bi bi-check-circle-fill text-success mb-3" style="font-size: 3rem;"></i>
                <h5 class="card-title">Estados de Evento</h5>
                <p class="card-text text-muted">Gestionar estados del ciclo de vida</p>
                <button class="btn btn-primary btn-sm" onclick="showOptions('estados-evento', 'Estados de Evento')">
                    Gestionar
                </button>
            </div>
        </div>
    </div>

    <!-- Eventos de Tráfico -->
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm hover-card" data-table="eventos">
            <div class="card-body text-center">
                <i class="bi bi-car-front-fill text-info mb-3" style="font-size: 3rem;"></i>
                <h5 class="card-title">Eventos de Tráfico</h5>
                <p class="card-text text-muted">Gestionar eventos principales</p>
                <button class="btn btn-primary btn-sm" onclick="showOptions('eventos', 'Eventos de Tráfico')">
                    Gestionar
                </button>
            </div>
        </div>
    </div>

    <!-- Rutas Afectadas -->
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm hover-card" data-table="rutas-afectadas">
            <div class="card-body text-center">
                <i class="bi bi-geo-alt-fill text-secondary mb-3" style="font-size: 3rem;"></i>
                <h5 class="card-title">Rutas Afectadas</h5>
                <p class="card-text text-muted">Gestionar rutas impactadas</p>
                <button class="btn btn-primary btn-sm" onclick="showOptions('rutas-afectadas', 'Rutas Afectadas')">
                    Gestionar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para opciones CRUD -->
<div class="modal fade" id="optionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Opciones</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="listItems()">
                        <i class="bi bi-list-ul me-2"></i>Listar
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="createItem()">
                        <i class="bi bi-plus-circle me-2"></i>Crear Nuevo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para listar elementos -->
<div class="modal fade" id="listModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="listModalTitle">Lista</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="loadingSpinner" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
                <div id="listContent" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar elementos -->
<div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="formModalTitle">Formulario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="formContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveItem()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Login -->
<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-circle me-2"></i>
                    Iniciar Sesión
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Usuario</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Contraseña</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-lock"></i></span>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                    </div>
                    <div id="loginError" class="alert alert-danger d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="performLogin()" id="loginButton">
                    <span id="loginSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                    Iniciar Sesión
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .hover-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        cursor: pointer;
    }
    
    .hover-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    .btn-action {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let currentTable = '';
    let currentTitle = '';
    let authToken = localStorage.getItem('authToken');
    
    // API Base URL
    const API_BASE = '/eventos/api/';
    const AUTH_BASE = '/api/';
    
    // Mapeo de endpoints
    const endpoints = {
        'tipos-evento': 'tipos-evento/',
        'niveles-gravedad': 'niveles-gravedad/',
        'estados-evento': 'estados-evento/',
        'eventos': 'eventos/',
        'rutas-afectadas': 'rutas-afectadas/'
    };
    
    // Configuración de campos para cada tabla
    const fieldConfigs = {
        'tipos-evento': {
            fields: ['nombre', 'descripcion', 'codigo'],
            labels: {'nombre': 'Nombre', 'descripcion': 'Descripción', 'codigo': 'Código'}
        },
        'niveles-gravedad': {
            fields: ['nombre', 'descripcion', 'nivel_numerico'],
            labels: {'nombre': 'Nombre', 'descripcion': 'Descripción', 'nivel_numerico': 'Nivel Numérico'}
        },
        'estados-evento': {
            fields: ['nombre', 'descripcion', 'codigo'],
            labels: {'nombre': 'Nombre', 'descripcion': 'Descripción', 'codigo': 'Código'}
        },
        'eventos': {
            fields: ['titulo', 'descripcion', 'fecha_inicio', 'fecha_fin', 'tipo_evento', 'nivel_gravedad', 'estado'],
            labels: {
                'titulo': 'Título',
                'descripcion': 'Descripción', 
                'fecha_inicio': 'Fecha Inicio',
                'fecha_fin': 'Fecha Fin',
                'tipo_evento': 'Tipo de Evento',
                'nivel_gravedad': 'Nivel de Gravedad',
                'estado': 'Estado'
            }
        },
        'rutas-afectadas': {
            fields: ['evento_trafico', 'ruta', 'coordenadas', 'descripcion_impacto'],
            labels: {
                'evento_trafico': 'Evento de Tráfico',
                'ruta': 'Ruta',
                'coordenadas': 'Coordenadas',
                'descripcion_impacto': 'Descripción del Impacto'
            }
        }
    };
    
    function showOptions(table, title) {
        currentTable = table;
        currentTitle = title;
        document.getElementById('modalTitle').textContent = title;
        new bootstrap.Modal(document.getElementById('optionsModal')).show();
    }
    
    function listItems() {
        bootstrap.Modal.getInstance(document.getElementById('optionsModal')).hide();
        
        document.getElementById('listModalTitle').textContent = `Lista de ${currentTitle}`;
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('listContent').style.display = 'none';
        
        const modal = new bootstrap.Modal(document.getElementById('listModal'));
        modal.show();
        
        // Hacer petición AJAX
        $.ajax({
            url: API_BASE + endpoints[currentTable],
            method: 'GET',
            headers: getAuthHeaders(),
            success: function(data) {
                displayList(data.results || data);
            },
            error: function(xhr, status, error) {
                if (xhr.status === 401) {
                    handleAuthError();
                    return;
                }
                document.getElementById('listContent').innerHTML = 
                    `<div class="alert alert-danger">Error al cargar los datos: ${error}</div>`;
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('listContent').style.display = 'block';
            }
        });
    }
    
    function displayList(items) {
        const config = fieldConfigs[currentTable];
        let html = `
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
        `;
        
        // Headers
        config.fields.forEach(field => {
            html += `<th>${config.labels[field]}</th>`;
        });
        html += `<th>Acciones</th></tr></thead><tbody>`;
        
        // Rows
        items.forEach(item => {
            html += `<tr><td>${item.id}</td>`;
            config.fields.forEach(field => {
                let value = item[field] || '-';
                if (typeof value === 'object' && value !== null) {
                    value = value.nombre || value.titulo || JSON.stringify(value);
                }
                html += `<td>${value}</td>`;
            });
            html += `
                <td>
                    <button class="btn btn-sm btn-outline-primary btn-action me-1" 
                            onclick="editItem(${item.id})">
                        <i class="bi bi-pencil"></i> Editar
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-action" 
                            onclick="deleteItem(${item.id})">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                </td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        
        document.getElementById('listContent').innerHTML = html;
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('listContent').style.display = 'block';
    }
    
    function createItem() {
        bootstrap.Modal.getInstance(document.getElementById('optionsModal')).hide();
        showForm('Crear ' + currentTitle);
    }
    
    function editItem(id) {
        bootstrap.Modal.getInstance(document.getElementById('listModal')).hide();
        
        // Obtener datos del item
        $.ajax({
            url: API_BASE + endpoints[currentTable] + id + '/',
            method: 'GET',
            headers: getAuthHeaders(),
            success: function(data) {
                showForm('Editar ' + currentTitle, data);
            },
            error: function(xhr, status, error) {
                if (xhr.status === 401) {
                    handleAuthError();
                    return;
                }
                alert('Error al obtener los datos del elemento: ' + error);
            }
        });
    }
    
    function showForm(title, data = null) {
        document.getElementById('formModalTitle').textContent = title;
        
        const config = fieldConfigs[currentTable];
        let html = '<form id="itemForm">';
        
        config.fields.forEach(field => {
            const value = data ? (data[field] || '') : '';
            const label = config.labels[field];
            
            if (field.includes('fecha')) {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label}</label>
                        <input type="datetime-local" class="form-control" id="${field}" name="${field}" 
                               value="${value ? new Date(value).toISOString().slice(0, 16) : ''}">
                    </div>
                `;
            } else if (field === 'nivel_numerico') {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label}</label>
                        <input type="number" class="form-control" id="${field}" name="${field}" 
                               value="${value}" min="1" max="10">
                    </div>
                `;
            } else if (field === 'descripcion' || field === 'descripcion_impacto') {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label}</label>
                        <textarea class="form-control" id="${field}" name="${field}" rows="3">${value}</textarea>
                    </div>
                `;
            } else {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label}</label>
                        <input type="text" class="form-control" id="${field}" name="${field}" value="${value}">
                    </div>
                `;
            }
        });
        
        html += '</form>';
        
        if (data) {
            html += `<input type="hidden" id="itemId" value="${data.id}">`;
        }
        
        document.getElementById('formContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('formModal')).show();
    }
    
    function saveItem() {
        const formData = new FormData(document.getElementById('itemForm'));
        const itemId = document.getElementById('itemId') ? document.getElementById('itemId').value : null;
        
        const data = {};
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }
        
        const method = itemId ? 'PUT' : 'POST';
        const url = itemId ? 
            API_BASE + endpoints[currentTable] + itemId + '/' : 
            API_BASE + endpoints[currentTable];
        
        $.ajax({
            url: url,
            method: method,
            headers: getAuthHeaders(),
            data: JSON.stringify(data),
            contentType: 'application/json',
            success: function(response) {
                bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();
                alert('Elemento guardado exitosamente');
            },
            error: function(xhr, status, error) {
                if (xhr.status === 401) {
                    handleAuthError();
                    return;
                }
                let errorMsg = 'Error al guardar el elemento';
                if (xhr.responseJSON) {
                    errorMsg += ': ' + JSON.stringify(xhr.responseJSON);
                }
                alert(errorMsg);
            }
        });
    }
    
    function deleteItem(id) {
        if (confirm('¿Estás seguro de que quieres eliminar este elemento?')) {
            $.ajax({
                url: API_BASE + endpoints[currentTable] + id + '/',
                method: 'DELETE',
                headers: getAuthHeaders(),
                success: function() {
                    alert('Elemento eliminado exitosamente');
                    listItems(); // Recargar la lista
                },
                error: function(xhr, status, error) {
                    if (xhr.status === 401) {
                        handleAuthError();
                        return;
                    }
                    alert('Error al eliminar el elemento: ' + error);
                }
            });
        }
    }
    
    // ============== FUNCIONES DE AUTENTICACIÓN ==============
    
    function getAuthHeaders() {
        const headers = {};
        if (authToken) {
            headers['Authorization'] = 'Bearer ' + authToken;
        }
        return headers;
    }
    
    function checkAuthStatus() {
        if (authToken) {
            // Verificar si el token es válido
            $.ajax({
                url: AUTH_BASE + 'token/verify/',
                method: 'POST',
                data: JSON.stringify({token: authToken}),
                contentType: 'application/json',
                success: function() {
                    showLoggedInState();
                },
                error: function() {
                    // Token inválido, limpiar
                    logout();
                }
            });
        } else {
            showLoggedOutState();
        }
    }
    
    function showLogin() {
        document.getElementById('loginError').classList.add('d-none');
        document.getElementById('loginForm').reset();
        new bootstrap.Modal(document.getElementById('loginModal')).show();
    }
    
    function performLogin() {
        const loginButton = document.getElementById('loginButton');
        const loginSpinner = document.getElementById('loginSpinner');
        const loginError = document.getElementById('loginError');
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
            loginError.textContent = 'Por favor, completa todos los campos';
            loginError.classList.remove('d-none');
            return;
        }
        
        // Mostrar spinner
        loginButton.disabled = true;
        loginSpinner.classList.remove('d-none');
        loginError.classList.add('d-none');
        
        $.ajax({
            url: AUTH_BASE + 'token/',
            method: 'POST',
            data: JSON.stringify({
                username: username,
                password: password
            }),
            contentType: 'application/json',
            success: function(response) {
                authToken = response.access;
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('refreshToken', response.refresh);
                localStorage.setItem('username', username);
                
                bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                showLoggedInState();
                
                // Recargar datos si hay una tabla activa
                if (currentTable) {
                    listItems();
                }
            },
            error: function(xhr) {
                let errorMsg = 'Error al iniciar sesión';
                if (xhr.responseJSON && xhr.responseJSON.detail) {
                    errorMsg = xhr.responseJSON.detail;
                } else if (xhr.status === 401) {
                    errorMsg = 'Credenciales incorrectas';
                }
                loginError.textContent = errorMsg;
                loginError.classList.remove('d-none');
            },
            complete: function() {
                loginButton.disabled = false;
                loginSpinner.classList.add('d-none');
            }
        });
    }
    
    function logout() {
        authToken = null;
        localStorage.removeItem('authToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('username');
        showLoggedOutState();
    }
    
    function showLoggedInState() {
        const username = localStorage.getItem('username');
        document.getElementById('loginNavItem').classList.add('d-none');
        document.getElementById('logoutNavItem').classList.remove('d-none');
        document.getElementById('userInfo').textContent = username || 'Usuario';
    }
    
    function showLoggedOutState() {
        document.getElementById('loginNavItem').classList.remove('d-none');
        document.getElementById('logoutNavItem').classList.add('d-none');
    }
    
    function handleAuthError() {
        alert('Sesión expirada. Por favor, inicia sesión nuevamente.');
        logout();
        showLogin();
    }
    
    function refreshToken() {
        const refresh = localStorage.getItem('refreshToken');
        if (!refresh) {
            logout();
            return Promise.reject('No refresh token');
        }
        
        return $.ajax({
            url: AUTH_BASE + 'token/refresh/',
            method: 'POST',
            data: JSON.stringify({refresh: refresh}),
            contentType: 'application/json'
        }).done(function(response) {
            authToken = response.access;
            localStorage.setItem('authToken', authToken);
        }).fail(function() {
            logout();
        });
    }
    
    // Inicializar estado de autenticación al cargar la página
    $(document).ready(function() {
        checkAuthStatus();
        
        // Manejar Enter en el formulario de login
        $('#loginForm').on('submit', function(e) {
            e.preventDefault();
            performLogin();
        });
    });
</script>
{% endblock %}