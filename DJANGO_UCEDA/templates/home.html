{% extends 'base.html' %}

{% block title %}Home - MOP Eventos de Tráfico{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-center mb-4">
            <i class="bi bi-house-door text-primary"></i>
            Sistema de Gestión de Eventos de Tráfico
        </h1>
        <p class="text-center text-muted mb-5">Selecciona una tabla para gestionar los datos</p>
    </div>
</div>

<div class="row g-4">
    <!-- Tipos de Evento -->
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm hover-card" data-table="tipos-evento">
            <div class="card-body text-center">
                <i class="bi bi-tags-fill text-warning mb-3" style="font-size: 3rem;"></i>
                <h5 class="card-title">Tipos de Evento</h5>
                <p class="card-text text-muted">Gestionar categorías de eventos</p>
                <button class="btn btn-primary btn-sm" onclick="showOptions('tipos-evento', 'Tipos de Evento')">
                    Gestionar
                </button>
            </div>
        </div>
    </div>

    <!-- Niveles de Gravedad -->
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm hover-card" data-table="niveles-gravedad">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle-fill text-danger mb-3" style="font-size: 3rem;"></i>
                <h5 class="card-title">Niveles de Gravedad</h5>
                <p class="card-text text-muted">Gestionar niveles de importancia</p>
                <button class="btn btn-primary btn-sm" onclick="showOptions('niveles-gravedad', 'Niveles de Gravedad')">
                    Gestionar
                </button>
            </div>
        </div>
    </div>

    <!-- Estados de Evento -->
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm hover-card" data-table="estados-evento">
            <div class="card-body text-center">
                <i class="bi bi-check-circle-fill text-success mb-3" style="font-size: 3rem;"></i>
                <h5 class="card-title">Estados de Evento</h5>
                <p class="card-text text-muted">Gestionar estados del ciclo de vida</p>
                <button class="btn btn-primary btn-sm" onclick="showOptions('estados-evento', 'Estados de Evento')">
                    Gestionar
                </button>
            </div>
        </div>
    </div>

    <!-- Eventos de Tráfico -->
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm hover-card" data-table="eventos">
            <div class="card-body text-center">
                <i class="bi bi-car-front-fill text-info mb-3" style="font-size: 3rem;"></i>
                <h5 class="card-title">Eventos de Tráfico</h5>
                <p class="card-text text-muted">Gestionar eventos principales</p>
                <button class="btn btn-primary btn-sm" onclick="showOptions('eventos', 'Eventos de Tráfico')">
                    Gestionar
                </button>
            </div>
        </div>
    </div>

    <!-- Rutas Afectadas -->
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm hover-card" data-table="rutas-afectadas">
            <div class="card-body text-center">
                <i class="bi bi-geo-alt-fill text-secondary mb-3" style="font-size: 3rem;"></i>
                <h5 class="card-title">Rutas Afectadas</h5>
                <p class="card-text text-muted">Gestionar rutas impactadas</p>
                <button class="btn btn-primary btn-sm" onclick="showOptions('rutas-afectadas', 'Rutas Afectadas')">
                    Gestionar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Divider entre Eventos y Transporte -->
<hr class="my-5" style="border-top: 3px solid #dee2e6;">

<!-- Sección de Gestión de Transporte -->
<div class="row mb-4">
    <div class="col-12">
        <h2 class="text-center mb-2">
            <i class="bi bi-bus-front text-success"></i>
            Gestión de Transporte Público
        </h2>
        <p class="text-center text-muted">Administrar empresas, conductores, vehículos y rutas</p>
    </div>
</div>

<div class="row g-4">
    <!-- Empresas de Transporte -->
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm hover-card" data-table="empresas-transporte">
            <div class="card-body text-center">
                <i class="bi bi-building text-primary mb-3" style="font-size: 3rem;"></i>
                <h5 class="card-title">Empresas de Transporte</h5>
                <p class="card-text text-muted">Gestionar operadores de transporte</p>
                <button class="btn btn-success btn-sm" onclick="showOptions('empresas-transporte', 'Empresas de Transporte')">
                    Gestionar
                </button>
            </div>
        </div>
    </div>

    <!-- Pilotos -->
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm hover-card" data-table="pilotos">
            <div class="card-body text-center">
                <i class="bi bi-person-badge text-warning mb-3" style="font-size: 3rem;"></i>
                <h5 class="card-title">Pilotos</h5>
                <p class="card-text text-muted">Gestionar conductores de autobús</p>
                <button class="btn btn-success btn-sm" onclick="showOptions('pilotos', 'Pilotos')">
                    Gestionar
                </button>
            </div>
        </div>
    </div>

    <!-- Autobuses -->
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm hover-card" data-table="autobuses">
            <div class="card-body text-center">
                <i class="bi bi-bus-front-fill text-info mb-3" style="font-size: 3rem;"></i>
                <h5 class="card-title">Autobuses</h5>
                <p class="card-text text-muted">Gestionar vehículos de transporte</p>
                <button class="btn btn-success btn-sm" onclick="showOptions('autobuses', 'Autobuses')">
                    Gestionar
                </button>
            </div>
        </div>
    </div>

    <!-- Rutas -->
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm hover-card" data-table="rutas">
            <div class="card-body text-center">
                <i class="bi bi-map text-success mb-3" style="font-size: 3rem;"></i>
                <h5 class="card-title">Rutas</h5>
                <p class="card-text text-muted">Gestionar recorridos de transporte</p>
                <button class="btn btn-success btn-sm" onclick="showOptions('rutas', 'Rutas')">
                    Gestionar
                </button>
            </div>
        </div>
    </div>

    <!-- Paradas -->
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 shadow-sm hover-card" data-table="paradas">
            <div class="card-body text-center">
                <i class="bi bi-signpost-2 text-danger mb-3" style="font-size: 3rem;"></i>
                <h5 class="card-title">Paradas</h5>
                <p class="card-text text-muted">Gestionar paradas de autobús</p>
                <button class="btn btn-success btn-sm" onclick="showOptions('paradas', 'Paradas')">
                    Gestionar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para opciones CRUD -->
<div class="modal fade" id="optionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Opciones</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="listItems()">
                        <i class="bi bi-list-ul me-2"></i>Listar
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="createItem()">
                        <i class="bi bi-plus-circle me-2"></i>Crear Nuevo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para listar elementos -->
<div class="modal fade" id="listModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="listModalTitle">Lista</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="loadingSpinner" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
                <div id="listContent" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar elementos -->
<div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="formModalTitle">Formulario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="formContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveItem()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Login -->
<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-circle me-2"></i>
                    Iniciar Sesión
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Usuario</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Contraseña</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-lock"></i></span>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                    </div>
                    <div id="loginError" class="alert alert-danger d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="performLogin()" id="loginButton">
                    <span id="loginSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                    Iniciar Sesión
                </button>
            </div>
            <div class="modal-footer border-top-0 pt-0">
                <small class="text-muted w-100 text-center">
                    ¿No tienes cuenta? 
                    <a href="#" onclick="switchToRegister()" class="text-decoration-none">Crear Cuenta</a>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Registro -->
<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus me-2"></i>
                    Crear Cuenta
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="mb-3">
                        <label for="registerUsername" class="form-label">Nombre de Usuario</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                            <input type="text" class="form-control" id="registerUsername" name="username" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="registerEmail" class="form-label">Correo Electrónico</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                            <input type="email" class="form-control" id="registerEmail" name="email" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="registerPassword" class="form-label">Contraseña</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-lock"></i></span>
                            <input type="password" class="form-control" id="registerPassword" name="password" required>
                        </div>
                        <div class="form-text">Mínimo 8 caracteres</div>
                    </div>
                    <div class="mb-3">
                        <label for="registerPasswordConfirm" class="form-label">Confirmar Contraseña</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                            <input type="password" class="form-control" id="registerPasswordConfirm" name="password_confirm" required>
                        </div>
                    </div>
                    <div id="registerError" class="alert alert-danger d-none"></div>
                    <div id="registerSuccess" class="alert alert-success d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="performRegister()" id="registerButton">
                    <span id="registerSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                    Crear Cuenta
                </button>
            </div>
            <div class="modal-footer border-top-0 pt-0">
                <small class="text-muted w-100 text-center">
                    ¿Ya tienes cuenta? 
                    <a href="#" onclick="switchToLogin()" class="text-decoration-none">Iniciar Sesión</a>
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .hover-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        cursor: pointer;
    }
    
    .hover-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    .btn-action {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let currentTable = '';
    let currentTitle = '';
    let authToken = localStorage.getItem('authToken');
    
    // API Base URL
    const API_BASE = '/api/';
    const AUTH_BASE = '/api/';
    
    // Mapeo de endpoints
    const endpoints = {
        'tipos-evento': 'tipos-evento/',
        'niveles-gravedad': 'niveles-gravedad/',
        'estados-evento': 'estados-evento/',
        'eventos': 'eventos/',
        'rutas-afectadas': 'rutas-afectadas/',
        // Endpoints de transporte
        'empresas-transporte': 'v1/rutas-viajes/empresas/',
        'pilotos': 'v1/rutas-viajes/pilotos/',
        'autobuses': 'v1/rutas-viajes/autobuses/',
        'rutas': 'v1/rutas-viajes/rutas/',
        'paradas': 'v1/rutas-viajes/paradas/'
    };
    
    // Configuración de campos para cada tabla
    const fieldConfigs = {
        'tipos-evento': {
            fields: ['nombre', 'descripcion', 'codigo'],
            labels: {'nombre': 'Nombre', 'descripcion': 'Descripción', 'codigo': 'Código'}
        },
        'niveles-gravedad': {
            fields: ['codigo', 'nombre', 'orden'],
            labels: {'codigo': 'Código', 'nombre': 'Nombre', 'orden': 'Orden'}
        },
        'estados-evento': {
            fields: ['nombre', 'descripcion', 'codigo'],
            labels: {'nombre': 'Nombre', 'descripcion': 'Descripción', 'codigo': 'Código'}
        },
        'eventos': {
            fields: ['titulo', 'descripcion', 'tipo', 'gravedad', 'estado', 'latitud', 'longitud', 'radio_metros', 'fecha_ocurrencia', 'fecha_reporte', 'expira_en'],
            labels: {
                'titulo': 'Título',
                'descripcion': 'Descripción',
                'tipo': 'Tipo de Evento',
                'gravedad': 'Nivel de Gravedad',
                'estado': 'Estado',
                'latitud': 'Latitud',
                'longitud': 'Longitud',
                'radio_metros': 'Radio en Metros',
                'fecha_ocurrencia': 'Fecha de Ocurrencia',
                'fecha_reporte': 'Fecha de Reporte',
                'expira_en': 'Fecha de Expiración'
            }
        },
        'rutas-afectadas': {
            fields: ['evento_trafico', 'ruta', 'coordenadas', 'descripcion_impacto'],
            labels: {
                'evento_trafico': 'Evento de Tráfico',
                'ruta': 'Ruta',
                'coordenadas': 'Coordenadas',
                'descripcion_impacto': 'Descripción del Impacto'
            }
        },
        // Configuraciones para transporte
        'empresas-transporte': {
            fields: ['nombre', 'codigo', 'contacto', 'telefono', 'activo'],
            labels: {
                'nombre': 'Nombre de la Empresa',
                'codigo': 'Código',
                'contacto': 'Persona de Contacto',
                'telefono': 'Teléfono',
                'activo': 'Activo'
            }
        },
        'pilotos': {
            fields: ['nombre', 'documento', 'licencia_numero', 'licencia_categoria', 'telefono', 'empresa', 'activo'],
            labels: {
                'nombre': 'Nombre Completo',
                'documento': 'Documento de Identidad',
                'licencia_numero': 'Número de Licencia',
                'licencia_categoria': 'Categoría de Licencia',
                'telefono': 'Teléfono',
                'empresa': 'Empresa',
                'activo': 'Activo'
            }
        },
        'autobuses': {
            fields: ['codigo', 'placa', 'capacidad', 'empresa', 'activo'],
            labels: {
                'codigo': 'Código del Autobús',
                'placa': 'Placa',
                'capacidad': 'Capacidad de Pasajeros',
                'empresa': 'Empresa',
                'activo': 'Activo'
            }
        },
        'rutas': {
            fields: ['codigo', 'nombre', 'descripcion', 'empresa', 'activo'],
            labels: {
                'codigo': 'Código de la Ruta',
                'nombre': 'Nombre de la Ruta',
                'descripcion': 'Descripción',
                'empresa': 'Empresa',
                'activo': 'Activo'
            }
        },
        'paradas': {
            fields: ['nombre', 'orden', 'sentido', 'latitud', 'longitud', 'ruta', 'activo'],
            labels: {
                'nombre': 'Nombre de la Parada',
                'orden': 'Orden',
                'sentido': 'Sentido',
                'latitud': 'Latitud',
                'longitud': 'Longitud',
                'ruta': 'Ruta',
                'activo': 'Activo'
            }
        }
    };
    
    function showOptions(table, title) {
        currentTable = table;
        currentTitle = title;
        document.getElementById('modalTitle').textContent = title;
        new bootstrap.Modal(document.getElementById('optionsModal')).show();
    }
    
    function listItems() {
        const optionsModalInstance = bootstrap.Modal.getInstance(document.getElementById('optionsModal'));
        if (optionsModalInstance) {
            optionsModalInstance.hide();
        }
        cleanupModalBackdrop();
        
        document.getElementById('listModalTitle').textContent = `Lista de ${currentTitle}`;
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('listContent').style.display = 'none';
        
        const modal = new bootstrap.Modal(document.getElementById('listModal'));
        modal.show();
        
        // Hacer petición AJAX
        $.ajax({
            url: API_BASE + endpoints[currentTable],
            method: 'GET',
            headers: getAuthHeaders(),
            success: function(data) {
                displayList(data.results || data);
            },
            error: function(xhr, status, error) {
                if (xhr.status === 401) {
                    handleAuthError();
                    return;
                }
                document.getElementById('listContent').innerHTML = 
                    `<div class="alert alert-danger">Error al cargar los datos: ${error}</div>`;
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('listContent').style.display = 'block';
            }
        });
    }
    
    function displayList(items) {
        const config = fieldConfigs[currentTable];
        let html = `
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
        `;
        
        // Headers
        config.fields.forEach(field => {
            html += `<th>${config.labels[field]}</th>`;
        });
        html += `<th>Acciones</th></tr></thead><tbody>`;
        
        // Rows
        items.forEach(item => {
            html += `<tr><td>${item.id}</td>`;
            config.fields.forEach(field => {
                let value = item[field] || '-';
                
                // Formateo especial para eventos
                if (currentTable === 'eventos') {
                    if (field === 'fecha_ocurrencia' || field === 'fecha_reporte' || field === 'expira_en') {
                        if (value && value !== '-') {
                            value = new Date(value).toLocaleString('es-ES', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    } else if (field === 'tipo') {
                        // Usar tipo_info para mostrar la información completa
                        if (item.tipo_info) {
                            value = `${item.tipo_info.nombre} (${item.tipo_info.codigo})`;
                        } else {
                            value = value || '-';
                        }
                    } else if (field === 'gravedad') {
                        // Usar gravedad_info para mostrar la información completa
                        if (item.gravedad_info) {
                            value = `${item.gravedad_info.nombre} (${item.gravedad_info.codigo})`;
                        } else {
                            value = value || '-';
                        }
                    } else if (field === 'estado') {
                        // Usar estado_info para mostrar la información completa
                        if (item.estado_info) {
                            value = `${item.estado_info.nombre} (${item.estado_info.codigo})`;
                        } else {
                            value = value || '-';
                        }
                    } else if (field === 'latitud' || field === 'longitud') {
                        if (value && value !== '-') {
                            value = parseFloat(value).toFixed(6);
                        }
                    } else if (field === 'radio_metros') {
                        if (value && value !== '-') {
                            value = `${value} m`;
                        }
                    }
                } else {
                    // Formateo para otras tablas
                    if (typeof value === 'object' && value !== null) {
                        value = value.nombre || value.titulo || JSON.stringify(value);
                    }
                }
                
                html += `<td>${value}</td>`;
            });
            html += `
                <td>
                    <button class="btn btn-sm btn-outline-primary btn-action me-1" 
                            onclick="editItem(${item.id})">
                        <i class="bi bi-pencil"></i> Editar
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-action" 
                            onclick="deleteItem(${item.id})">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                </td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        
        document.getElementById('listContent').innerHTML = html;
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('listContent').style.display = 'block';
    }
    
    function createItem() {
        const optionsModalInstance = bootstrap.Modal.getInstance(document.getElementById('optionsModal'));
        if (optionsModalInstance) {
            optionsModalInstance.hide();
        }
        cleanupModalBackdrop();
        showForm('Crear ' + currentTitle);
    }
    
    function editItem(id) {
        const listModalInstance = bootstrap.Modal.getInstance(document.getElementById('listModal'));
        if (listModalInstance) {
            listModalInstance.hide();
        }
        cleanupModalBackdrop();
        
        // Obtener datos del item
        $.ajax({
            url: API_BASE + endpoints[currentTable] + id + '/',
            method: 'GET',
            headers: getAuthHeaders(),
            success: function(data) {
                showForm('Editar ' + currentTitle, data);
            },
            error: function(xhr, status, error) {
                if (xhr.status === 401) {
                    handleAuthError();
                    return;
                }
                alert('Error al obtener los datos del elemento: ' + error);
            }
        });
    }
    
    function showForm(title, data = null) {
        document.getElementById('formModalTitle').textContent = title;
        
        // Si estamos creando/editando eventos, necesitamos cargar los catálogos
        if (currentTable === 'eventos') {
            loadEventFormWithCatalogs(title, data);
        } else if (currentTable === 'pilotos' || currentTable === 'autobuses' || currentTable === 'rutas') {
            // Para pilotos, autobuses y rutas necesitamos cargar el catálogo de empresas
            loadFormWithCompanyCatalog(title, data);
        } else {
            generateStandardForm(title, data);
        }
    }
    
    function loadEventFormWithCatalogs(title, data = null) {
        // Mostrar indicador de carga
        document.getElementById('formContent').innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando formulario...</span>
                </div>
                <p class="mt-2">Cargando opciones...</p>
            </div>
        `;
        new bootstrap.Modal(document.getElementById('formModal')).show();
        
        // Cargar los catálogos en paralelo
        const catalogPromises = [
            $.ajax({
                url: API_BASE + endpoints['tipos-evento'],
                method: 'GET',
                headers: getAuthHeaders()
            }),
            $.ajax({
                url: API_BASE + endpoints['niveles-gravedad'],
                method: 'GET',
                headers: getAuthHeaders()
            }),
            $.ajax({
                url: API_BASE + endpoints['estados-evento'],
                method: 'GET',
                headers: getAuthHeaders()
            })
        ];
        
        Promise.all(catalogPromises)
            .then(responses => {
                const [tiposEvento, nivelesGravedad, estadosEvento] = responses;
                generateEventForm(title, data, {
                    tiposEvento: tiposEvento.results || tiposEvento,
                    nivelesGravedad: nivelesGravedad.results || nivelesGravedad,
                    estadosEvento: estadosEvento.results || estadosEvento
                });
            })
            .catch(error => {
                if (error.status === 401) {
                    handleAuthError();
                    return;
                }
                document.getElementById('formContent').innerHTML = `
                    <div class="alert alert-danger">
                        Error al cargar las opciones del formulario: ${error.responseText || error.statusText}
                    </div>
                `;
            });
    }
    
    function loadFormWithCompanyCatalog(title, data = null) {
        // Mostrar indicador de carga
        document.getElementById('formContent').innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando formulario...</span>
                </div>
                <p class="mt-2">Cargando opciones de empresas...</p>
            </div>
        `;
        new bootstrap.Modal(document.getElementById('formModal')).show();
        
        // Cargar el catálogo de empresas
        $.ajax({
            url: API_BASE + endpoints['empresas-transporte'],
            method: 'GET',
            headers: getAuthHeaders()
        })
        .then(response => {
            const empresas = response.results || response;
            generateFormWithCompanies(title, data, empresas);
        })
        .catch(error => {
            if (error.status === 401) {
                handleAuthError();
                return;
            }
            document.getElementById('formContent').innerHTML = `
                <div class="alert alert-danger">
                    Error al cargar las empresas: ${error.responseText || error.statusText}
                </div>
            `;
        });
    }
    
    function generateEventForm(title, data, catalogs) {
        const config = fieldConfigs[currentTable];
        let html = '<form id="itemForm">';
        
        config.fields.forEach(field => {
            const value = data ? (data[field] || '') : '';
            const label = config.labels[field];
            
            if (field.includes('fecha')) {
                const isRequired = (field === 'fecha_ocurrencia' || field === 'fecha_reporte');
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label}${isRequired ? ' <span class="text-danger">*</span>' : ''}</label>
                        <input type="datetime-local" class="form-control" id="${field}" name="${field}" 
                               value="${value ? new Date(value).toISOString().slice(0, 16) : ''}"
                               ${isRequired ? 'required' : ''}>
                    </div>
                `;
            } else if (field === 'tipo') {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label} <span class="text-danger">*</span></label>
                        <select class="form-control" id="${field}" name="${field}" required>
                            <option value="">Seleccionar tipo de evento...</option>
                `;
                catalogs.tiposEvento.forEach(tipo => {
                    let selected = '';
                    if (data) {
                        // Verificar si data.tipo es un ID o un objeto
                        const tipoId = typeof data.tipo === 'object' ? data.tipo : data.tipo;
                        selected = (tipoId === tipo.id) ? 'selected' : '';
                    }
                    html += `<option value="${tipo.id}" ${selected}>${tipo.nombre} (${tipo.codigo})</option>`;
                });
                html += `
                        </select>
                    </div>
                `;
            } else if (field === 'gravedad') {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label} <span class="text-danger">*</span></label>
                        <select class="form-control" id="${field}" name="${field}" required>
                            <option value="">Seleccionar nivel de gravedad...</option>
                `;
                // Ordenar por el campo orden
                const sortedNiveles = catalogs.nivelesGravedad.sort((a, b) => a.orden - b.orden);
                sortedNiveles.forEach(nivel => {
                    let selected = '';
                    if (data) {
                        // Verificar si data.gravedad es un ID o un objeto
                        const gravedadId = typeof data.gravedad === 'object' ? data.gravedad : data.gravedad;
                        selected = (gravedadId === nivel.id) ? 'selected' : '';
                    }
                    html += `<option value="${nivel.id}" ${selected}>${nivel.nombre} (${nivel.codigo})</option>`;
                });
                html += `
                        </select>
                    </div>
                `;
            } else if (field === 'estado') {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label} <span class="text-danger">*</span></label>
                        <select class="form-control" id="${field}" name="${field}" required>
                            <option value="">Seleccionar estado...</option>
                `;
                catalogs.estadosEvento.forEach(estado => {
                    let selected = '';
                    if (data) {
                        // Verificar si data.estado es un ID o un objeto
                        const estadoId = typeof data.estado === 'object' ? data.estado : data.estado;
                        selected = (estadoId === estado.id) ? 'selected' : '';
                    }
                    html += `<option value="${estado.id}" ${selected}>${estado.nombre} (${estado.codigo})</option>`;
                });
                html += `
                        </select>
                    </div>
                `;
            } else if (field === 'descripcion') {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label} <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="${field}" name="${field}" rows="3" required>${value}</textarea>
                    </div>
                `;
            } else if (field === 'latitud') {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label} <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="${field}" name="${field}" 
                               value="${value}" step="0.000001" min="-90" max="90" 
                               placeholder="Ej: -12.046374" required>
                        <div class="form-text">Latitud válida entre -90 y 90 grados</div>
                    </div>
                `;
            } else if (field === 'longitud') {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label} <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="${field}" name="${field}" 
                               value="${value}" step="0.000001" min="-180" max="180" 
                               placeholder="Ej: -77.042793" required>
                        <div class="form-text">Longitud válida entre -180 y 180 grados</div>
                    </div>
                `;
            } else if (field === 'radio_metros') {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label} <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="${field}" name="${field}" 
                               value="${value}" min="1" max="50000" 
                               placeholder="Ej: 500" required>
                        <div class="form-text">Radio de afectación en metros (1-50000)</div>
                    </div>
                `;
            } else {
                // Campos de texto normales (titulo)
                const isRequired = (field === 'titulo');
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label}${isRequired ? ' <span class="text-danger">*</span>' : ''}</label>
                        <input type="text" class="form-control" id="${field}" name="${field}" value="${value}"
                               ${isRequired ? 'required' : ''}>
                    </div>
                `;
            }
        });
        
        html += '</form>';
        
        if (data) {
            html += `<input type="hidden" id="itemId" value="${data.id}">`;
        }
        
        document.getElementById('formContent').innerHTML = html;
    }
    
    function generateFormWithCompanies(title, data, empresas) {
        const config = fieldConfigs[currentTable];
        let html = '<form id="itemForm">';
        
        config.fields.forEach(field => {
            const value = data ? (data[field] || '') : '';
            const label = config.labels[field];
            
            if (field === 'empresa') {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label} <span class="text-danger">*</span></label>
                        <select class="form-control" id="${field}" name="${field}" required>
                            <option value="">Seleccionar empresa...</option>
                `;
                empresas.forEach(empresa => {
                    let selected = '';
                    if (data && data.empresa) {
                        // Manejar tanto si empresa viene como ID o como objeto
                        const empresaId = typeof data.empresa === 'object' ? data.empresa.id : data.empresa;
                        selected = (empresaId === empresa.id) ? 'selected' : '';
                    }
                    html += `<option value="${empresa.id}" ${selected}>${empresa.codigo} - ${empresa.nombre}</option>`;
                });
                html += `
                        </select>
                    </div>
                `;
            } else if (field === 'capacidad') {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label} <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="${field}" name="${field}" 
                               value="${value}" min="1" max="200" required>
                        <div class="form-text">Capacidad de pasajeros (1-200)</div>
                    </div>
                `;
            } else if (field === 'activo') {
                html += `
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="${field}" name="${field}" 
                                   ${value ? 'checked' : ''}>
                            <label class="form-check-label" for="${field}">
                                ${label}
                            </label>
                        </div>
                    </div>
                `;
            } else if (field === 'descripcion') {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label}</label>
                        <textarea class="form-control" id="${field}" name="${field}" rows="3">${value}</textarea>
                    </div>
                `;
            } else {
                // Campos de texto normales
                const isRequired = (field === 'nombre' || field === 'documento' || field === 'licencia_numero' || 
                                   field === 'codigo' || field === 'placa');
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label}${isRequired ? ' <span class="text-danger">*</span>' : ''}</label>
                        <input type="text" class="form-control" id="${field}" name="${field}" value="${value}"
                               ${isRequired ? 'required' : ''}>
                    </div>
                `;
            }
        });
        
        html += '</form>';
        
        if (data) {
            html += `<input type="hidden" id="itemId" value="${data.id}">`;
        }
        
        document.getElementById('formContent').innerHTML = html;
    }
    
    function generateStandardForm(title, data = null) {
        const config = fieldConfigs[currentTable];
        let html = '<form id="itemForm">';
        
        config.fields.forEach(field => {
            const value = data ? (data[field] || '') : '';
            const label = config.labels[field];
            
            if (field.includes('fecha')) {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label}</label>
                        <input type="datetime-local" class="form-control" id="${field}" name="${field}" 
                               value="${value ? new Date(value).toISOString().slice(0, 16) : ''}">
                    </div>
                `;
            } else if (field === 'orden') {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label}</label>
                        <input type="number" class="form-control" id="${field}" name="${field}" 
                               value="${value}" min="1" max="32767" required>
                        <div class="form-text">Orden del nivel (1=menor gravedad, mayor número=más grave)</div>
                    </div>
                `;
            } else if (field === 'descripcion' || field === 'descripcion_impacto') {
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label}</label>
                        <textarea class="form-control" id="${field}" name="${field}" rows="3">${value}</textarea>
                    </div>
                `;
            } else {
                const isRequired = (currentTable === 'niveles-gravedad' && (field === 'codigo' || field === 'nombre'));
                const maxLength = (currentTable === 'niveles-gravedad' && field === 'codigo') ? '16' : 
                                 (currentTable === 'niveles-gravedad' && field === 'nombre') ? '32' : '';
                const style = (currentTable === 'niveles-gravedad' && field === 'codigo') ? 'text-transform: uppercase;' : '';
                
                html += `
                    <div class="mb-3">
                        <label for="${field}" class="form-label">${label}${isRequired ? ' <span class="text-danger">*</span>' : ''}</label>
                        <input type="text" class="form-control" id="${field}" name="${field}" value="${value}"
                               ${isRequired ? 'required' : ''} ${maxLength ? `maxlength="${maxLength}"` : ''} 
                               style="${style}">
                        ${currentTable === 'niveles-gravedad' && field === 'codigo' ? 
                            '<div class="form-text">Código único del nivel (máximo 16 caracteres, se convertirá a mayúsculas)</div>' : ''}
                        ${currentTable === 'niveles-gravedad' && field === 'nombre' ? 
                            '<div class="form-text">Nombre descriptivo del nivel (máximo 32 caracteres)</div>' : ''}
                    </div>
                `;
            }
        });
        
        html += '</form>';
        
        if (data) {
            html += `<input type="hidden" id="itemId" value="${data.id}">`;
        }
        
        document.getElementById('formContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('formModal')).show();
    }
    
    function saveItem() {
        const formData = new FormData(document.getElementById('itemForm'));
        const itemId = document.getElementById('itemId') ? document.getElementById('itemId').value : null;
        
        const data = {};
        for (let [key, value] of formData.entries()) {
            // Procesar campos específicos para niveles de gravedad
            if (currentTable === 'niveles-gravedad') {
                if (key === 'codigo') {
                    data[key] = value.toUpperCase().trim();
                } else if (key === 'orden') {
                    data[key] = parseInt(value);
                } else {
                    data[key] = value.trim();
                }
            } else if (currentTable === 'eventos') {
                // Procesar campos específicos para eventos
                if (key === 'tipo' || key === 'gravedad' || key === 'estado') {
                    // Convertir a entero para las llaves foráneas
                    data[key] = value ? parseInt(value) : null;
                } else if (key === 'fecha_ocurrencia' || key === 'fecha_reporte' || key === 'expira_en') {
                    // Convertir fechas al formato correcto
                    data[key] = value ? new Date(value).toISOString() : null;
                } else if (key === 'latitud' || key === 'longitud') {
                    // Convertir coordenadas a decimal
                    data[key] = value ? parseFloat(value) : null;
                } else if (key === 'radio_metros') {
                    // Convertir radio a entero
                    data[key] = value ? parseInt(value) : null;
                } else {
                    data[key] = value;
                }
            } else if (currentTable === 'pilotos' || currentTable === 'autobuses' || currentTable === 'rutas') {
                // Procesar campos específicos para transporte (pilotos, autobuses, rutas)
                if (key === 'empresa') {
                    // Convertir empresa a entero para la llave foránea
                    data[key] = value ? parseInt(value) : null;
                } else if (key === 'capacidad') {
                    // Convertir capacidad a entero
                    data[key] = value ? parseInt(value) : null;
                } else if (key === 'activo') {
                    // Los checkboxes pueden venir como string o boolean
                    data[key] = value === 'on' || value === true || value === 'true';
                } else {
                    data[key] = value.trim ? value.trim() : value;
                }
            } else {
                data[key] = value;
            }
        }
        
        // Para campos de transporte, asegurar que 'activo' tenga un valor por defecto si no está presente
        if (currentTable === 'pilotos' || currentTable === 'autobuses' || currentTable === 'rutas' || currentTable === 'empresas-transporte') {
            if (!data.hasOwnProperty('activo')) {
                data.activo = false; // Si el checkbox no está marcado, no aparece en formData
            }
        }
        
        // Validación específica para niveles de gravedad
        if (currentTable === 'niveles-gravedad') {
            if (!data.codigo || !data.nombre || !data.orden || data.orden <= 0) {
                alert('Por favor, complete todos los campos requeridos correctamente.');
                return;
            }
        }
        
        // Validación específica para eventos
        if (currentTable === 'eventos') {
            if (!data.titulo || !data.descripcion || !data.tipo || !data.gravedad || !data.estado || 
                !data.latitud || !data.longitud || !data.radio_metros) {
                alert('Por favor, complete todos los campos requeridos: Título, Descripción, Tipo, Gravedad, Estado, Latitud, Longitud y Radio en Metros.');
                return;
            }
            
            // Validar rangos de coordenadas
            if (data.latitud < -90 || data.latitud > 90) {
                alert('La latitud debe estar entre -90 y 90 grados.');
                return;
            }
            
            if (data.longitud < -180 || data.longitud > 180) {
                alert('La longitud debe estar entre -180 y 180 grados.');
                return;
            }
            
            if (data.radio_metros <= 0 || data.radio_metros > 50000) {
                alert('El radio debe estar entre 1 y 50000 metros.');
                return;
            }
            
            // Validar fechas si están presentes
            if (data.fecha_ocurrencia && data.expira_en) {
                const fechaOcurrencia = new Date(data.fecha_ocurrencia);
                const fechaExpiracion = new Date(data.expira_en);
                if (fechaExpiracion <= fechaOcurrencia) {
                    alert('La fecha de expiración debe ser posterior a la fecha de ocurrencia.');
                    return;
                }
            }
        }
        
        // Validación específica para transporte
        if (currentTable === 'pilotos') {
            if (!data.nombre || !data.documento || !data.licencia_numero || !data.empresa) {
                alert('Por favor, complete todos los campos requeridos: Nombre, Documento, Licencia y Empresa.');
                return;
            }
        } else if (currentTable === 'autobuses') {
            if (!data.codigo || !data.placa || !data.capacidad || !data.empresa) {
                alert('Por favor, complete todos los campos requeridos: Código, Placa, Capacidad y Empresa.');
                return;
            }
            if (data.capacidad <= 0 || data.capacidad > 200) {
                alert('La capacidad debe estar entre 1 y 200 pasajeros.');
                return;
            }
        } else if (currentTable === 'rutas') {
            if (!data.codigo || !data.nombre || !data.empresa) {
                alert('Por favor, complete todos los campos requeridos: Código, Nombre y Empresa.');
                return;
            }
        }
        
        const method = itemId ? 'PUT' : 'POST';
        const url = itemId ? 
            API_BASE + endpoints[currentTable] + itemId + '/' : 
            API_BASE + endpoints[currentTable];
        
        $.ajax({
            url: url,
            method: method,
            headers: getAuthHeaders(),
            data: JSON.stringify(data),
            contentType: 'application/json',
            success: function(response) {
                // Ocultar el modal y limpiar backdrop manualmente
                const modalInstance = bootstrap.Modal.getInstance(document.getElementById('formModal'));
                if (modalInstance) {
                    modalInstance.hide();
                }
                
                // Limpiar backdrop manualmente para evitar que quede bloqueada la página
                setTimeout(() => {
                    // Remover cualquier backdrop que pueda haber quedado
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                    
                    // Remover clases del body que pueden causar problemas
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }, 200);
                
                alert('Elemento guardado exitosamente');
                
                // Si hay una lista abierta, recargarla
                if (document.getElementById('listModal').classList.contains('show')) {
                    listItems();
                }
            },
            error: function(xhr, status, error) {
                if (xhr.status === 401) {
                    handleAuthError();
                    return;
                }
                let errorMsg = 'Error al guardar el elemento';
                if (xhr.responseJSON) {
                    if (typeof xhr.responseJSON === 'object') {
                        const errors = [];
                        for (const [field, messages] of Object.entries(xhr.responseJSON)) {
                            if (Array.isArray(messages)) {
                                errors.push(`${field}: ${messages.join(', ')}`);
                            } else {
                                errors.push(`${field}: ${messages}`);
                            }
                        }
                        errorMsg += ':\n' + errors.join('\n');
                    } else {
                        errorMsg += ': ' + xhr.responseJSON;
                    }
                }
                alert(errorMsg);
            }
        });
    }
    
    function deleteItem(id) {
        if (confirm('¿Estás seguro de que quieres eliminar este elemento?')) {
            $.ajax({
                url: API_BASE + endpoints[currentTable] + id + '/',
                method: 'DELETE',
                headers: getAuthHeaders(),
                success: function() {
                    alert('Elemento eliminado exitosamente');
                    listItems(); // Recargar la lista
                },
                error: function(xhr, status, error) {
                    if (xhr.status === 401) {
                        handleAuthError();
                        return;
                    }
                    alert('Error al eliminar el elemento: ' + error);
                }
            });
        }
    }
    
    // ============== FUNCIONES DE AUTENTICACIÓN ==============
    
    function getAuthHeaders() {
        const headers = {};
        if (authToken) {
            headers['Authorization'] = 'Bearer ' + authToken;
        }
        return headers;
    }
    
    function checkAuthStatus() {
        if (authToken) {
            // Verificar si el token es válido
            $.ajax({
                url: AUTH_BASE + 'token/verify/',
                method: 'POST',
                data: JSON.stringify({token: authToken}),
                contentType: 'application/json',
                success: function() {
                    showLoggedInState();
                },
                error: function() {
                    // Token inválido, limpiar
                    logout();
                }
            });
        } else {
            showLoggedOutState();
        }
    }
    
    function showLogin() {
        document.getElementById('loginError').classList.add('d-none');
        document.getElementById('loginForm').reset();
        new bootstrap.Modal(document.getElementById('loginModal')).show();
    }
    
    function performLogin() {
        const loginButton = document.getElementById('loginButton');
        const loginSpinner = document.getElementById('loginSpinner');
        const loginError = document.getElementById('loginError');
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
            loginError.textContent = 'Por favor, completa todos los campos';
            loginError.classList.remove('d-none');
            return;
        }
        
        // Mostrar spinner
        loginButton.disabled = true;
        loginSpinner.classList.remove('d-none');
        loginError.classList.add('d-none');
        
        $.ajax({
            url: AUTH_BASE + 'token/',
            method: 'POST',
            data: JSON.stringify({
                username: username,
                password: password
            }),
            contentType: 'application/json',
            success: function(response) {
                authToken = response.access;
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('refreshToken', response.refresh);
                localStorage.setItem('username', username);
                
                const loginModalInstance = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                if (loginModalInstance) {
                    loginModalInstance.hide();
                }
                cleanupModalBackdrop();
                showLoggedInState();
                
                // Recargar datos si hay una tabla activa
                if (currentTable) {
                    listItems();
                }
            },
            error: function(xhr) {
                let errorMsg = 'Error al iniciar sesión';
                if (xhr.responseJSON && xhr.responseJSON.detail) {
                    errorMsg = xhr.responseJSON.detail;
                } else if (xhr.status === 401) {
                    errorMsg = 'Credenciales incorrectas';
                }
                loginError.textContent = errorMsg;
                loginError.classList.remove('d-none');
            },
            complete: function() {
                loginButton.disabled = false;
                loginSpinner.classList.add('d-none');
            }
        });
    }
    
    function logout() {
        authToken = null;
        localStorage.removeItem('authToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('username');
        showLoggedOutState();
    }
    
    function showLoggedInState() {
        const username = localStorage.getItem('username');
        document.getElementById('loginNavItem').classList.add('d-none');
        document.getElementById('logoutNavItem').classList.remove('d-none');
        document.getElementById('userInfo').textContent = username || 'Usuario';
    }
    
    function showLoggedOutState() {
        document.getElementById('loginNavItem').classList.remove('d-none');
        document.getElementById('logoutNavItem').classList.add('d-none');
    }
    
    function handleAuthError() {
        alert('Sesión expirada. Por favor, inicia sesión nuevamente.');
        logout();
        showLogin();
    }
    
    // ============== FUNCIONES DE NAVEGACIÓN ENTRE MODALES ==============
    
    function switchToRegister() {
        // Cerrar modal de login
        const loginModalInstance = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
        if (loginModalInstance) {
            loginModalInstance.hide();
        }
        
        // Limpiar y mostrar modal de registro
        setTimeout(() => {
            document.getElementById('registerForm').reset();
            document.getElementById('registerError').classList.add('d-none');
            document.getElementById('registerSuccess').classList.add('d-none');
            new bootstrap.Modal(document.getElementById('registerModal')).show();
        }, 300);
    }
    
    function switchToLogin() {
        // Cerrar modal de registro
        const registerModalInstance = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
        if (registerModalInstance) {
            registerModalInstance.hide();
        }
        
        // Limpiar y mostrar modal de login
        setTimeout(() => {
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('d-none');
            new bootstrap.Modal(document.getElementById('loginModal')).show();
        }, 300);
    }
    
    // ============== FUNCIONES DE REGISTRO ==============
    
    function performRegister() {
        const registerButton = document.getElementById('registerButton');
        const registerSpinner = document.getElementById('registerSpinner');
        const registerError = document.getElementById('registerError');
        const registerSuccess = document.getElementById('registerSuccess');
        
        const username = document.getElementById('registerUsername').value.trim();
        const email = document.getElementById('registerEmail').value.trim();
        const password = document.getElementById('registerPassword').value;
        const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
        
        // Validaciones básicas
        if (!username || !email || !password || !passwordConfirm) {
            registerError.textContent = 'Por favor, completa todos los campos';
            registerError.classList.remove('d-none');
            registerSuccess.classList.add('d-none');
            return;
        }
        
        if (password !== passwordConfirm) {
            registerError.textContent = 'Las contraseñas no coinciden';
            registerError.classList.remove('d-none');
            registerSuccess.classList.add('d-none');
            return;
        }
        
        if (password.length < 8) {
            registerError.textContent = 'La contraseña debe tener al menos 8 caracteres';
            registerError.classList.remove('d-none');
            registerSuccess.classList.add('d-none');
            return;
        }
        
        // Mostrar spinner
        registerButton.disabled = true;
        registerSpinner.classList.remove('d-none');
        registerError.classList.add('d-none');
        registerSuccess.classList.add('d-none');
        
        // Realizar registro
        $.ajax({
            url: API_BASE + 'register/',
            method: 'POST',
            data: JSON.stringify({
                username: username,
                email: email,
                password: password,
                password_confirm: passwordConfirm
            }),
            contentType: 'application/json',
            success: function(response) {
                registerSuccess.innerHTML = `
                    <strong>¡Cuenta creada exitosamente!</strong><br>
                    Bienvenido/a ${response.user.username}. Ahora puedes iniciar sesión.
                `;
                registerSuccess.classList.remove('d-none');
                
                // Limpiar formulario
                document.getElementById('registerForm').reset();
                
                // Después de 3 segundos, cambiar al modal de login
                setTimeout(() => {
                    switchToLogin();
                }, 3000);
            },
            error: function(xhr) {
                let errorMsg = 'Error al crear la cuenta';
                
                if (xhr.responseJSON) {
                    if (xhr.responseJSON.username) {
                        errorMsg = xhr.responseJSON.username[0];
                    } else if (xhr.responseJSON.email) {
                        errorMsg = xhr.responseJSON.email[0];
                    } else if (xhr.responseJSON.password) {
                        errorMsg = xhr.responseJSON.password[0];
                    } else if (xhr.responseJSON.password_confirm) {
                        errorMsg = xhr.responseJSON.password_confirm[0];
                    } else if (xhr.responseJSON.detail) {
                        errorMsg = xhr.responseJSON.detail;
                    }
                }
                
                registerError.textContent = errorMsg;
                registerError.classList.remove('d-none');
                registerSuccess.classList.add('d-none');
            },
            complete: function() {
                registerButton.disabled = false;
                registerSpinner.classList.add('d-none');
            }
        });
    }
    
    function refreshToken() {
        const refresh = localStorage.getItem('refreshToken');
        if (!refresh) {
            logout();
            return Promise.reject('No refresh token');
        }
        
        return $.ajax({
            url: AUTH_BASE + 'token/refresh/',
            method: 'POST',
            data: JSON.stringify({refresh: refresh}),
            contentType: 'application/json'
        }).done(function(response) {
            authToken = response.access;
            localStorage.setItem('authToken', authToken);
        }).fail(function() {
            logout();
        });
    }
    
    // Función para limpiar backdrops de modal
    function cleanupModalBackdrop() {
        setTimeout(() => {
            // Remover cualquier backdrop que pueda haber quedado
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Remover clases del body que pueden causar problemas
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }, 200);
    }
    
    // Inicializar estado de autenticación al cargar la página
    $(document).ready(function() {
        checkAuthStatus();
        
        // Manejar Enter en el formulario de login
        $('#loginForm').on('submit', function(e) {
            e.preventDefault();
            performLogin();
        });
        
        // Manejar Enter en el formulario de registro
        $('#registerForm').on('submit', function(e) {
            e.preventDefault();
            performRegister();
        });
        
        // Agregar event listeners para limpiar backdrop cuando se cierren los modales
        $('#formModal').on('hidden.bs.modal', function() {
            cleanupModalBackdrop();
        });
        
        $('#listModal').on('hidden.bs.modal', function() {
            cleanupModalBackdrop();
        });
        
        $('#optionsModal').on('hidden.bs.modal', function() {
            cleanupModalBackdrop();
        });
        
        $('#loginModal').on('hidden.bs.modal', function() {
            cleanupModalBackdrop();
        });
        
        $('#registerModal').on('hidden.bs.modal', function() {
            cleanupModalBackdrop();
        });
    });
</script>
{% endblock %}